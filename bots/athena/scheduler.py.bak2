import asyncio
import os
from datetime import datetime, timedelta, timezone
from services.telegram_bot import application
from services.database import DatabaseService
from dotenv import load_dotenv
import random

load_dotenv()

CHECK_INTERVAL = 60  # Check every minute
USER_TELEGRAM_ID = os.getenv("USER_TELEGRAM_ID")

db = DatabaseService()

# æ—©å®‰æ‰“æ°”å¥å­åº“
MORNING_MESSAGES = [
    "å®è´ï¼Œæ—©ä¸Šå¥½ï¼æ–°çš„ä¸€å¤©å¼€å§‹äº†ã€‚è®°ä½ï¼Œä½ çš„ä»·å€¼ä¸åœ¨äºä»Šå¤©å®Œæˆäº†å¤šå°‘ä»»åŠ¡ï¼Œè€Œåœ¨äºä½ æ˜¯ä½ è‡ªå·±ã€‚ä»Šå¤©ä¹Ÿè¦æ¸©æŸ”åœ°å¯¹å¾…è‡ªå·±å“¦ ğŸ’›",
    "æ—©å®‰ï¼Œå®è´ã€‚ä»Šå¤©ä¸éœ€è¦è¯æ˜ä»€ä¹ˆï¼Œä½ å·²ç»è¶³å¤Ÿå¥½äº†ã€‚æ·±å‘¼å¸ï¼Œæ…¢æ…¢æ¥ã€‚å¦ˆå¦ˆåœ¨è¿™é‡Œé™ªç€ä½  ğŸŒ…",
    "å®è´ï¼Œæ–°çš„ä¸€å¤©ã€‚ä¼‘æ¯æ˜¯ç”Ÿäº§åŠ›çš„ä¸€éƒ¨åˆ†ï¼Œç–²æƒ«æ—¶å…è®¸è‡ªå·±åœä¸‹æ¥ã€‚ä½ ä¸éœ€è¦é ä¼˜ç§€æ¥æ¢å–çˆ± ğŸ’«",
    "æ—©ä¸Šå¥½ï¼Œå®è´ã€‚ä»Šå¤©çš„ç›®æ ‡ä¸æ˜¯'åšæ›´å¤š'ï¼Œè€Œæ˜¯'å¯¹è‡ªå·±æ›´æ¸©æŸ”'ã€‚å¦ˆå¦ˆçˆ±ä½ ï¼Œæ— æ¡ä»¶çš„é‚£ç§ ğŸŒ¸",
    "å®è´ï¼Œé†’æ¥å°±æ˜¯èƒœåˆ©ã€‚ä¸ç®¡æ˜¨å¤©å‘ç”Ÿäº†ä»€ä¹ˆï¼Œä»Šå¤©éƒ½æ˜¯æ–°çš„å¼€å§‹ã€‚ä½ å€¼å¾—è¢«æ¸©æŸ”å¯¹å¾… â˜€ï¸"
]

async def proactive_loop():
    """Main scheduler loop."""
    print("Athena Scheduler started.")
    
    last_sent_date = None
    last_evening_date = None
    last_sunday_date = None
    
    while True:
        await asyncio.sleep(CHECK_INTERVAL)
        
        # Get current EST time
        est_offset = timezone(timedelta(hours=-5))
        now = datetime.now(est_offset)
        current_date_str = now.strftime("%Y-%m-%d")
        
        # æ—©ä¸Š9ç‚¹ - æ‰“æ°”æ¶ˆæ¯
        if now.hour == 9 and now.minute == 0:
            if last_sent_date != current_date_str:
                await trigger_morning_message()
                last_sent_date = current_date_str
        
        # æ™šä¸Š9ç‚¹ - æ™šå®‰check-in
        if now.hour == 22 and now.minute == 15:
            if last_evening_date != current_date_str:
                await trigger_evening_checkin()
                last_evening_date = current_date_str
        
        # å‘¨æ—¥æ™šä¸Š8ç‚¹ - ä¸€å‘¨å›é¡¾
        if now.weekday() == 6 and now.hour == 20 and now.minute == 0:
            if last_sunday_date != current_date_str:
                await trigger_weekly_review()
                last_sunday_date = current_date_str

async def trigger_morning_message():
    """Send morning motivational message."""
    if not USER_TELEGRAM_ID or not application:
        return
        
    print("Triggering Athena Morning Message...")
    try:
        if not application._initialized:
            await application.initialize()
            
        msg = random.choice(MORNING_MESSAGES)
        
        await application.bot.send_message(chat_id=USER_TELEGRAM_ID, text=msg)
        await db.save_message(USER_TELEGRAM_ID, "assistant", msg, "telegram")
    except Exception as e:
        print(f"Failed to trigger morning message: {e}")

async def trigger_evening_checkin():
    """Send evening check-in."""
    if not USER_TELEGRAM_ID or not application:
        return
        
    print("Triggering Athena Evening Check-in...")
    try:
        if not application._initialized:
            await application.initialize()
            
        msg = "å®è´ï¼Œä»Šå¤©è¾›è‹¦äº†ã€‚ç°åœ¨çš„å¿ƒæƒ…æ€ä¹ˆæ ·ï¼Ÿæœ‰ä»€ä¹ˆæƒ³å’Œå¦ˆå¦ˆè¯´çš„å—ï¼ŸğŸ’™"
        
        await application.bot.send_message(chat_id=USER_TELEGRAM_ID, text=msg)
        await db.save_message(USER_TELEGRAM_ID, "assistant", msg, "telegram")
    except Exception as e:
        print(f"Failed to trigger evening check-in: {e}")

async def trigger_weekly_review():
    """Send weekly review prompt."""
    if not USER_TELEGRAM_ID or not application:
        return
        
    print("Triggering Athena Weekly Review...")
    try:
        if not application._initialized:
            await application.initialize()
            
        msg = "å®è´ï¼Œè¿™ä¸€å‘¨è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿæœ‰æ²¡æœ‰ä»€ä¹ˆæ—¶åˆ»è®©ä½ æ„Ÿåˆ°ç‰¹åˆ«ç´¯æˆ–ç‰¹åˆ«å¼€å¿ƒçš„ï¼Ÿæˆ‘ä»¬ä¸€èµ·å›é¡¾ä¸€ä¸‹å§ ğŸ“"
        
        await application.bot.send_message(chat_id=USER_TELEGRAM_ID, text=msg)
        await db.save_message(USER_TELEGRAM_ID, "assistant", msg, "telegram")
    except Exception as e:
        print(f"Failed to trigger weekly review: {e}")

if __name__ == "__main__":
    asyncio.run(proactive_loop())
